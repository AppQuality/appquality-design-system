# This is a basic workflow to help you get started with Actions

name: Publish storybook

# The event that will trigger the action
on:
  push:
    branches: [develop]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'ci skip') && !contains(github.event.head_commit.message, 'skip ci')"

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - uses: actions/checkout@v2
      - name: Prepare repository
        run: git fetch --unshallow --tags
      - name: Use Node.js 12.x
        uses: actions/setup-node@v1
        with:
          node-version: 12.x
      - name: Cache node modules
        uses: actions/cache@v1
        with:
          path: node_modules
          key: npm-deps-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            npm-deps-${{ hashFiles('package-lock.json') }}
      - name: Publish storybook
        id: storybook
        run: |
          npm ci
          npx chromatic --project-token  ${{ secrets.CHROMATIC_TOKEN }} --exit-zero-on-changes --ci > /tmp/cires
          echo ::set-output name=visual_changes::"$(cat /tmp/cires | grep "✖ Found")$(cat /tmp/cires | grep "No visual changes")%0A"
          echo ::set-output name=build_url::"$(cat /tmp/cires | grep "ℹ View build details")"
      - name: Slack Post
        # You may pin to the exact commit or the version.
        # uses: devtk0582/slack-post-action@b9e9a7b9cb8f4cff41f6eacaf7b077f204e8a081
        uses: devtk0582/slack-post-action@v1.2
        with:
          # Slack Webhook Url
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          # Message to send
          MESSAGE: ${{ steps.storybook.outputs.visual_changes }}${{ steps.storybook.outputs.build_url }}
